{% extends "bookings/layout.html" %}

{% block title %}{{ property.title }}{% endblock %}

{% block body %}
<div class="row">
  <!-- Property Image and Details -->
  <div class="col-md-8">
    {% if property.image %}
      <img src="{{ property.image.url }}" class="img-fluid rounded mb-3" alt="{{ property.title }}">
    {% else %}
      <div class="bg-secondary text-white p-5 rounded mb-3 text-center">
        <h3>No Image Available</h3>
      </div>
    {% endif %}

    <h1>{{ property.title }}</h1>
    <h5 class="text-muted mb-3">üìç {{ property.location }}</h5>

    <!-- Server-side Django messages -->
    {% if messages %}
      <div class="mb-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">About this property</h5>
        <p class="card-text">{{ property.description }}</p>
      </div>
    </div>

    <!-- Map Section -->
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Map</h5>
        {% if latitude and longitude and bbox %}
          <iframe
            width="100%"
            height="400"
            frameborder="0"
            scrolling="no"
            marginheight="0"
            marginwidth="0"
            src="https://www.openstreetmap.org/export/embed.html?bbox={{ bbox.min_lon }},{{ bbox.min_lat }},{{ bbox.max_lon }},{{ bbox.max_lat }}&layer=mapnik&marker={{ latitude }},{{ longitude }}">
          </iframe>
          <br/>
          <small>
            <a href="https://www.openstreetmap.org/?mlat={{ latitude }}&mlon={{ longitude }}#map=13/{{ latitude }}/{{ longitude }}">
              View Larger Map
            </a>
          </small>
        {% else %}
          <p class="text-muted m-0">üó∫Ô∏è Location not available</p>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Property Details</h5>
        <ul class="list-unstyled">
          <li>üë• Maximum Guests: <strong>{{ property.max_guests }}</strong></li>
          <li>üõèÔ∏è Bedrooms: <strong>{{ property.bedrooms }}</strong></li>
          <li>üë§ Owner: <strong>{{ property.owner.username }}</strong></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Booking Form -->
  <div class="col-md-4">
    <div class="card sticky-top" style="top: 20px;">
      <div class="card-body">
        <h4 class="card-title">¬£{{ property.price_per_night }}</h4>
        <p class="text-muted">per night</p>

        {% if user.is_authenticated %}
          {% if property.owner == user %}
            <div class="alert alert-danger">Owners cannot book their own property.</div>
          {% else %}
            <form method="post" id="booking_form" action="{% url 'create_booking' property.id %}">
              {% csrf_token %}
              <div class="mb-3">
                <label for="check_in" class="form-label">Check-in</label>
                <input type="date" class="form-control" id="check_in" name="check_in" required>
              </div>
              <div class="mb-3">
                <label for="check_out" class="form-label">Check-out</label>
                <input type="date" class="form-control" id="check_out" name="check_out" required>
              </div>
              <div class="mb-3">
                <label for="num_guests" class="form-label">Number of Guests</label>
                <input type="number" class="form-control" id="num_guests" name="num_guests"
                       min="1" max="{{ property.max_guests }}" required>
              </div>
              <button type="submit" class="btn btn-primary w-100">Book Now</button>
            </form>
          {% endif %}
        {% else %}
          <div class="alert alert-info">
            <a href="{% url 'login' %}">Login</a> to book this property
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="mt-3">
  <a href="{% url 'index' %}" class="btn btn-secondary">‚Üê Back to Properties</a>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const checkInInput = document.getElementById('check_in');
    const checkOutInput = document.getElementById('check_out');
    const guestsInput = document.getElementById('num_guests');
    const bookingForm = document.getElementById('booking_form');
    const MAX_GUESTS = parseInt("{{ property.max_guests|default_if_none:6 }}", 10);


    function validateDates() {
        if (!checkInInput.value || !checkOutInput.value) return true;

        const checkInDate = new Date(checkInInput.value);
        const checkOutDate = new Date(checkOutInput.value);

        if (checkInDate.getDay() !== 6 || checkOutDate.getDay() !== 6) {
            alert("Check-in and check-out must be Saturdays.");
            return false;
        }

        const diff = (checkOutDate - checkInDate) / (1000*60*60*24);
        if (diff !== 7) {
            alert("Bookings must be exactly 7 nights (Saturday to Saturday).");
            return false;
        }

        return true;
    }

    function validateGuests() {
        if (!guestsInput.value) return true;

        const guests = parseInt(guestsInput.value, 10);
        if (guests > MAX_GUESTS) {
            alert(`Maximum guests allowed: ${MAX_GUESTS}`);
            guestsInput.value = MAX_GUESTS;
            return false;
        }

        return true;
    }

    if (bookingForm) {
        checkInInput.addEventListener('change', validateDates);
        checkOutInput.addEventListener('change', validateDates);
        guestsInput.addEventListener('input', validateGuests);

        bookingForm.addEventListener('submit', function(e) {
            if (!validateDates() || !validateGuests()) {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}
